@model Capstone_20130302.Models.Product

@{
    ViewBag.Title = "New Product";
}
For <b>@ViewBag.Store.StoreName</b>, under category <b>@ViewBag.Category.Name</b>.<br /><br />
<a href="/Product"><i class='icon icon-circle-arrow-left'></i> Back to Product List</a>


@using (Html.BeginForm(null, null, FormMethod.Post, new { @class = "create", data_bind="submit: save", enctype = "multipart/form-data" }))
{
    @Html.ValidationSummary(true)
    <legend>Product Details</legend>
    <div class="editor-field">
        <div class="upload-wrapper">
            <div>
                <img style="height: 140px; margin-bottom: 20px;" src="/Images/placeholder.png"><br>
                <span>Choose up to 3 images for your product.</span>
            </div>
        </div>
        <input id="uploadFiles" name="uploadFiles[]" style="display: none;" type="file" multiple="" accept="image/*"/>
    </div>
    
    <div class="row">
        <div class="span6">
            <legend>Description</legend>
            <div class="editor-field">
                @Html.ValidationMessageFor(model => model.Name)
                @Html.TextBoxFor(model => model.Name, new { @class = "span5", placeholder = @Html.DisplayNameFor(model => model.Name) })
            </div>

            <div class="editor-field">
                @Html.ValidationMessageFor(model => model.Description)
                @Html.TextAreaFor(model => model.Description, new { @class = "span5", placeholder = @Html.DisplayNameFor(model => model.Description), rows = "3" })
            </div>

            <div class="editor-field">
                @Html.ValidationMessageFor(model => model.Price)
                @Html.TextBoxFor(model => model.Price, new { @class="span5", placeholder = @Html.DisplayNameFor(model => model.Price)})
            </div>
        </div>
        <div class="span5">
            <legend>Specifications</legend>
            <div class="editor-field">
                @Html.HiddenFor(model => model.SpecsInJson)
                <table class="table table-bordered table-as-form">
                    <thead>
                        <tr>
                            <th colspan="3"><span data-bind='text: specs().length'>&nbsp;</span> specification<span data-bind='visible: specs().length>1'>s</span> 
                                <button type="button" class="btn btn-mini add pull-right" data-bind='click: addSpec'><i class="icon icon-white icon-plus"></i> Add</button></th>
                        </tr>
                    </thead>
                    <tbody data-bind='foreach: specs'>
                        <tr>
                            <td><input type="text" placeholder="Specification" class='required' data-bind='value: name, uniqueName: true' /></td>
                            <td><input type="text" placeholder="Description" class='required' data-bind='value: content, uniqueName: true' /></td>
                            <td><a href='' class="rm" data-bind='click: $root.removeSpec'><i class="icon-trash"></i></a></td>
                        </tr>
                    </tbody>
                </table>
             
                
            </div>
        </div>
    </div>
    <input type="hidden" name="cid" value="@ViewBag.Category.CategoryId"/>
    <input type="hidden" name="sid" value="@ViewBag.Store.StoreId"/>
    <br>
    <center>
        <input class="btn span3" type="submit" value="Create" /> 
    </center>
}

<div>
    
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}

<style>
    .field-validation-error {
        display: block;
    }
    .upload-wrapper {
        background: rgba(255, 255, 255, 0.43);
        border: dashed 1px #CCC;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    .upload-wrapper:hover {
        background-color: #FFFFE7;
    }
    .upload-wrapper div {
        margin: 40px auto;
        display: block;
        width: 300px;
        text-align: center;
    }
    .upload-wrapper img.select {
        height: 180px;
        padding: 2px;
        border: solid 1px #CCC;
        margin: 16px 8px;
        background: white;
        box-shadow: 0px 0px 4px #CACACA;
    }
    .upload-wrapper img.select:first-child {
        margin-left: 16px;
    }
    .table-as-form {
        background-color: #fff;
    }
        .table-as-form th {
            padding: 8px 0 4px 10px;
            background: -webkit-linear-gradient(top, white, #E6E6E6);
            text-shadow: 1px 2px 1px white;
            color: #505050;
            font-weight: normal;
            text-transform: uppercase;
        }

        .table-as-form input[type=text] {
            border: none;
            padding: 0;
            margin: 0;
            background: transparent;
            box-shadow: none;
            width: 100%;
        }
        .table-as-form tr:hover {
            background-color: #FFFFE7;
        }
        .table-as-form tr > td:first-child {
            width: 35%;
        }
        .table-as-form tr > td:last-child {
            width: 5%;
        }
    .table-bordered th:not(:first-child), .table-bordered td:not(:first-child) {
        border-left: none;
    }
    .rm {   
        opacity: 0;
    }
    .add {
        position: relative;
        top: -2px;
        right: 5px;
    }
    .table-as-form tr:hover .rm {
        opacity: 1;
    }

</style>

<script src="/Scripts/knockout-2.2.1.js"></script>
<script>
    var uploadWrapper;
    var inputFiles;
    $(function () {
        uploadWrapper = $(".upload-wrapper");
        inputFiles = $("#uploadFiles");

        uploadWrapper.click(function () {
            inputFiles.trigger("click");
        });

        inputFiles.change(function () {
            var length = inputFiles[0].files.length;
            console.log(length);
            if (length > 3) {
                alert("Please select only 3 images for your product.");
                return;
            }
            for (var i = 0; i < length; i++) {
                var f = inputFiles[0].files[i];
                if (!f.type.match(/image.*/)) {
                    alert("Please select image with correct format.");
                    return;
                }
            };
            uploadWrapper.html("");
            readmultifiles(inputFiles[0].files);
        });

        function readmultifiles(files) {
            var reader = new FileReader();  

            function readFile(index) {
                if( index >= files.length ) return;

                var file = files[index];
                reader.onload = function(e) {  
                    // get file content
                    uploadWrapper.append("<img class='select' src='" + e.target.result + "'/>");
                    readFile(index+1);
                }
                reader.readAsDataURL(file);
            }
            readFile(0);
        }

        var specsJsonData = @Html.Raw(Model.SpecsInJson);

        var SpecModel = function (specs) {
            var self = this;
            self.specs = ko.observableArray(specs);
         
            self.addSpec = function() {
                self.specs.push({
                    name: "",
                    content: ""
                });
            };
         
            self.removeSpec = function(spec) {
                self.specs.remove(spec);
            };
         
            self.save = function (form) {
                console.log(ko.utils.stringifyJson(self.specs));
                $("#SpecsInJson").val(ko.utils.stringifyJson(self.specs));
                return true;
            };
        };
         
        var viewModel = new SpecModel(specsJsonData);
        ko.applyBindings(viewModel);
         
        // Activate jQuery Validation
        $("form.create").validate({ submitHandler: function () { viewModel.save; $("form.create")[0].submit() } });
    })
</script>